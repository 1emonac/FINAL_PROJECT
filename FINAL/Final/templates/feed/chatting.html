{% extends "base.html" %}
{% load static %}
{% block head %}
<!--헤드에 들어갈 나머지 코드들을 입력해주세요-->
{% endblock %}
{% block content %}
<script>
    // WebSocket JS의 send API를 통해 서버로 메시지를 보내면, 서버에서 동일 메시지로 응답 -> onmessage 콜백이 호출

    // ws protocol in http page
    // wss protocol in https page
    const ws = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/chat/');

    // 배포 환경에 따른 protocol/host 변경에 대응하기
    // const protocol = location.protocol === "http:" ? "ws:" : "wss:";
    // const ws_url = protocol + "//" + location.host + "chat/";
    // const ws = new WebSocket(ws_url);

    ws.onopen = () => {
        console.log("웹소켓 서버와 접속됨.");
    };

    ws.onmessage = (event) => {
        const message = event.data;
        // message가 json 포맷의 문자열이 아니라면 SyntaxError 예외 발생
        const obj = JSON.parse(message);
        console.log("메세지 수신 :", message);
        console.log(obj);
    };

    ws.onerror = () => {
        console.error("웹소켓 에러 발생");
    };

    ws.onclose = (event) => {
        if(event.wasClean) {
            console.log("ws.close()에 의한 연결 끊기");
        }
        else {
            // 서버 프로세스가 죽거나 네트워크 장애
            console.log("웹소켓 서버와의 네트워크 단절로 인한 끊김");
        }
    };
    // 웹소켓 서버가 멈추거나 네트워크 장애가 발생되면, 클라이언트에서는 onerror, onclose 콜백이 호출됨
    // 웹소켓 서버와 재연결 하려면 페이지를 새로고침하거나, JS 만으로는 WebSocket 객체를 재생성

</script>

{% endblock %}
