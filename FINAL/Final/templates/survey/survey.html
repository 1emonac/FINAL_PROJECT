{% extends "base_chat.html" %}
{% load static %}
{% load django_bootstrap5 %}

{% block head %}
<style>
    #chat-message-list {
        padding: 0;
        list-style: none;
        /* overflow-y: scroll; */
        height: 500px; /* 메시지 리스트 높이 조정 */
    }
    .chat-message .message {
        background-color: #3b3b3d;
        color: #e1e1e1;
        border-radius: 0.8em;
        padding: 0.4em;
        margin: 0.4em 0;
        display: inline-block;
        white-space: pre-wrap;
    }
    .chat-message.me {
        text-align: right;
    }
    .chat-message.me .message {
        background-color: #1f8cff;
        color: #fff;
        text-align: left;
    }
    .room-name {
        font-size: 3rem; /* 원하는 크기로 조정 */
    }
    .card-header {
        font-weight: bold;
        text-align: center;
        font-size: 1.3rem;
    }
    .custom-chat-width {
        max-width: 900px;  /* 최대 너비 설정 */
        margin: auto;  /* 중앙 정렬 */
    }
    .card-footer {
        text-align: center;
        font-size: 1rem;
        color: rgb(129, 129, 129);
    }
</style>
{% endblock %}

{% block content %}
<div class="card custom-chat-width" style="margin-top: 100px; margin-bottom: 50px;"> 
    <div class="row">
        <div class="col-sm-12">
            <div class="card" style="height: 700px;">
                <div class="card-header ibm-plex-sans-kr-regular">
                    수면 진단 CHATBOT
                </div>
                <ul id="chat-message-list" class="chat-message-list">
                    <form method="post" action="{% url 'survey:survey' %}" >
                        {% csrf_token %}
                        <p class="chat-message-list chat-message .message">{{ question.text }}</p>
                        {% if question.question_type == "choice" or question.question_type == "multiple" %}
                            {% for choice in question.choices.all %}
                                <label>
                                    {% if question.question_type == "multiple" %}
                                        <input type="checkbox" name="response" value="{{ choice.id }}">
                                    {% else %}
                                        <input type="radio" name="response" value="{{ choice.id }}">
                                    {% endif %}
                                    {{ choice.choice_text }}
                                </label><br>
                            {% endfor %}
                        {% else %}
                            <input type="text" name="response" placeholder="답변해 주세요">
                        {% endif %}
                        <input type="hidden" name="question_id" value="{{ question.id }}">
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </form>
                </ul>
            </div>
            <div class="card-footer noto-sans-kr-main">
                해당하는 답변을 선택해 주세요.
            </div>
        </div>
    </div>
</div>

<script>
    const surveyHandler = {
    ws: null,
    currentQuestionId: null,

    init() {
        this.connect();
    },

    connect() {
        this.ws = new WebSocket(`ws://${window.location.host}/ws/survey/`);
        
        this.ws.onopen = this.onopen.bind(this);
        this.ws.onmessage = this.onmessage.bind(this);
    },

    onopen() {
        console.log("WebSocket connection established.");
        this.requestNextQuestion();
    },

    onmessage(event) {
        const data = JSON.parse(event.data);
        console.log("메세지 수신 :", data);

        switch (data.type) {
            case 'question':
                this.currentQuestionId = data.questionId; // Update current question ID
                this.displayQuestion(data.question, data.choices, data.questionType);
                break;
            case 'end':
                this.displayEndMessage();
                break;
            case "chat.message":
                this.append_message("Eunoianest 수면 진단 서비스에 어서 오세요.");
                break;
            default:
                console.error(`Invalid message type: ${data.type}`);
        }
    },

    requestNextQuestion() {
        this.ws.send(JSON.stringify({ action: 'next_question', questionId: this.currentQuestionId }));
    },

    displayQuestion(question, choices, type) {
        const ul = document.getElementById('chat-message-list');
        ul.innerHTML = '';
        let questionItem = document.createElement('li');
        questionItem.classList.add('chat-message');
        questionItem.innerHTML = `<div class="message">${question}</div>`;
        ul.appendChild(questionItem);

        choices.forEach(choice => {
            let choiceItem = document.createElement('li');
            choiceItem.classList.add('chat-message');
            choiceItem.innerHTML = `<label><input type="${type === 'multiple' ? 'checkbox' : 'radio'}" name="response" value="${choice.id}"> ${choice.choice_text}</label>`;
            ul.appendChild(choiceItem);
        });

        let submitButton = document.createElement('button');
        submitButton.textContent = 'Submit';
        submitButton.classList.add('btn', 'btn-primary');
        submitButton.onclick = this.submitResponse.bind(this);
        ul.appendChild(submitButton);
    },

    submitResponse() {
        const selectedResponses = Array.from(document.querySelectorAll('input[name="response"]:checked')).map(input => input.value);
        this.ws.send(JSON.stringify({ action: 'submit_response', questionId: this.currentQuestionId, responses: selectedResponses }));
        this.requestNextQuestion();
    },

    displayEndMessage() {
        const ul = document.getElementById('chat-message-list');
        let messageItem = document.createElement('li');
        messageItem.classList.add('chat-message');
        messageItem.innerHTML = `<div class="message">Thank you for completing the survey.</div>`;
        ul.appendChild(messageItem);
    },

    append_message(message) {
        const element = document.createElement("div");
        element.className = "chat-message"; // 메시지 스타일링 목적

        const wrapper = document.createElement("div");
        wrapper.textContent = message;
        element.appendChild(wrapper);

        this.chat_messages_tag.appendChild(element);
        this.chat_messages_tag.scrollTop = this.chat_messages_tag.scrollHeight; // scroll to the bottom
    }
};

surveyHandler.init();

</script>
{% endblock %}
