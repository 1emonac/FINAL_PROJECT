{% extends "base_chat.html" %}
{% load static %}

{% block head %}
<link href="{% static 'css/drchat.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<br />
<div class="row2">
   <div class="col-sm-7" style="margin-top: 100px; margin-bottom: 50px;">
        <div class="card" style="height: 700px;">
            <div class="card-header">
                Dr.Eunoia와의 대화
            </div>
            <div class="card-body">
                <ul id="chat-message-list">
                </ul>
            </div>
            <div class="card-footer">
                <div class="d-flex gap-2">
                    <form id="message-form" class="d-flex gap-1 flex-grow-1">
                        <input type="text"
                            name="message"
                            placeholder="메시지를 입력하세요."
                            class="form-control flex-grow-1" />
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        function addMessage(message, isMe) {
            const messageList = document.getElementById("chat-message-list");
            const messageElement = document.createElement("li");
            messageElement.className = "chat-message" + (isMe ? " me" : "");
            messageElement.innerHTML = `<span class="message">${message}</span>`;
            messageList.appendChild(messageElement);
            messageList.scrollTop = messageList.scrollHeight;
        }

        const ws = new WebSocket(`ws://${window.location.host}/ws/survey/`);  // WebSocket URL을 '/ws/survey/'로 설정

        ws.onopen = function(e) { console.log("장고 채널스 서버와 웹소켓 연결되었습니다."); };
        ws.onclose = function(e) { console.log("장고 채널스 서버와 웹소켓이 끊어졌습니다."); };
        ws.onerror = function(e) { console.error("장고 채널스 서버와의 웹소켓 연결 중에 오류가 발생했습니다.", e); };

        ws.onmessage = function(e) {
            const message_obj = JSON.parse(e.data);
            if (message_obj.type === "assistant-message") {
                const { message } = message_obj;
                console.log("assistant-message :", message);
                addMessage(message, false);
            } else {
                console.error("알 수 없는 메시지 타입입니다.", message_obj);
            }
        };

        const messageForm = document.querySelector("#message-form");
        messageForm.onsubmit = function(e) {
            e.preventDefault();
            const message = e.target.message.value.trim();
            if(message.length > 0) {
                addMessage(message, true);
                ws.send(JSON.stringify({ type: "user-message", message: message }));
                e.target.reset();
            }
        };
    })();
</script>
{% endblock %}
