{% extends "chat_base.html" %}

{% block content %}
    <h2> 채팅방 : {{ room_name }}</h2>

    {# TODO: 웹소켓으로 실시간 채팅 기능 구현하기#}

    <hr />

    <a href="{% url 'chat:index' %}">대기실로 이동</a>

<script>
    const handlers = {
        chat_messages_tag: null,
        ws: null,
        retry: 0,
        username_set: new Set(),
    
        // 초기화
        // init() 함수에서는 채팅 메시지 form에서 submit 이벤트가 발생하면 onsubmit() 함수가 호출되도록 이벤트 리스너 할당
        init() {
            this.chat_messages_tag = document.querySelector("#chat_messages");
            document.querySelector("#message_form")
                .addEventListener("submit", this.onsubmit.bind(this));
        },
        // 채팅 메시지 로그 창 끝에 새로운 메시지를 추가
        // append_message(메시지) 함수를 호출하면, 메시지로그에 메시지가 한 줄 씩 추가되도록 구성
        append_message(message, sender) {
            const element = document.createElement("div");
            element.className = "chat-message"; // 메시지 스타일링 목적
            element.textContent = message;
            this.chat_messages_tag.appendChild(element);
            this.chat_messages_tag.scrollTop = this.chat_messages_tag.scrollHeight; // scroll to the bottom
        },
        // 채팅 메시지 입력폼에 대한 submit 이벤트 핸들러
        // onsubmit() 호출 시에는 아직 웹소켓 통신은 하진 않지만, append_message 함수 호출을 통해 입력된 메시지를 메시지로그에 추가
        onsubmit(event) {
            event.preventDefault(); // submit 기본 동작을 무시
    
            const form_data = new FormData(event.target);
            const props = Object.fromEntries(form_data);
            event.target.reset();  // reset form
    
            const { message } = props;
            console.log("웹소켓으로 전송할 메세지 :", message);
    
        this.append_message(message);
        },
    };
    
    handlers.init();
</script>
{% endblock %}